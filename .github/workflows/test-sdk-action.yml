name: PostHog SDK Compliance Tests

on:
  workflow_call:
    inputs:
      adapter-dockerfile:
        description: "Path to the SDK adapter Dockerfile"
        required: true
        type: string
      adapter-context:
        description: "Build context for the adapter (directory containing Dockerfile)"
        required: false
        type: string
        default: "."
      test-harness-version:
        description: "Version of the test harness to use (e.g., 'latest', '1.0', '1.0.0')"
        required: false
        type: string
        default: "latest"
      report-name:
        description: "Name for the test report artifact"
        required: false
        type: string
        default: "sdk-compliance-report"
    outputs:
      tests-passed:
        description: "Whether all tests passed"
        value: ${{ jobs.test.outputs.tests-passed }}
      report-path:
        description: "Path to the test report"
        value: ${{ jobs.test.outputs.report-path }}

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      pull-requests: write
    outputs:
      tests-passed: ${{ steps.run-tests.outcome == 'success' }}
      report-path: "sdk-compliance-report.md"

    steps:
      - name: Checkout SDK repository
        uses: actions/checkout@v4
        with:
          path: sdk-repo

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull test harness image
        run: docker pull ghcr.io/posthog/sdk-test-harness:${{ inputs.test-harness-version }}

      - name: Build SDK adapter
        uses: docker/build-push-action@v5
        with:
          context: sdk-repo/${{ inputs.adapter-context }}
          file: sdk-repo/${{ inputs.adapter-context }}/${{ inputs.adapter-dockerfile }}
          tags: sdk-adapter:test
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create Docker network
        run: docker network create test-network

      - name: Start SDK adapter
        run: |
          docker run -d \
            --name sdk-adapter \
            --network test-network \
            -e PORT=8080 \
            sdk-adapter:test

      - name: Create report directory
        run: mkdir -p ${{ github.workspace }}/report

      - name: Run tests
        id: run-tests
        continue-on-error: true
        run: |
          docker run --rm \
            --name test-harness \
            --network test-network \
            -v ${{ github.workspace }}/report:/report \
            ghcr.io/posthog/sdk-test-harness:${{ inputs.test-harness-version }} \
            run \
            --adapter-url http://sdk-adapter:8080 \
            --mock-url http://test-harness:8081 \
            --output text \
            --report /report/sdk-compliance-report.md

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.report-name }}
          path: report/sdk-compliance-report.md

      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = '${{ github.workspace }}/report/sdk-compliance-report.md';

            if (!fs.existsSync(reportPath)) {
              console.log('Report file not found, skipping PR comment');
              return;
            }

            const report = fs.readFileSync(reportPath, 'utf8');
            const commentMarker = '<!-- posthog-sdk-compliance-report -->';
            const body = `${commentMarker}\n${report}`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existingComment = comments.find(comment =>
              comment.body.includes(commentMarker)
            );

            if (existingComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
              console.log('Updated existing comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
              console.log('Created new comment');
            }

      - name: Stop containers
        if: always()
        run: |
          docker stop sdk-adapter || true
          docker rm sdk-adapter || true
          docker network rm test-network || true

      - name: Fail if tests failed
        if: steps.run-tests.outcome != 'success'
        run: exit 1

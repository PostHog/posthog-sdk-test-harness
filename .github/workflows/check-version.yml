name: Check Version Update

permissions:
  contents: read

on:
  pull_request:
    paths:
      - 'src/**'
      - 'CONTRACT.yaml'
      - 'pyproject.toml'
      - 'Dockerfile'

jobs:
  check-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout base branch
        run: |
          git fetch origin ${{ github.base_ref }}

      - name: Check if version was updated
        run: |
          # Get version from PR branch
          PR_VERSION=$(grep '^version = ' pyproject.toml | cut -d'"' -f2)

          # Get version from base branch
          git show origin/${{ github.base_ref }}:pyproject.toml > /tmp/base_pyproject.toml
          BASE_VERSION=$(grep '^version = ' /tmp/base_pyproject.toml | cut -d'"' -f2)

          echo "Base version: $BASE_VERSION"
          echo "PR version: $PR_VERSION"

          if [ "$PR_VERSION" == "$BASE_VERSION" ]; then
            echo "❌ Error: Version not updated in pyproject.toml"
            echo ""
            echo "You're changing the test harness code but haven't updated the version."
            echo "Please update the version in pyproject.toml following semantic versioning:"
            echo ""
            echo "  - Patch (0.1.0 -> 0.1.1): Bug fixes, documentation"
            echo "  - Minor (0.1.0 -> 0.2.0): New tests, new actions (backward compatible)"
            echo "  - Major (0.1.0 -> 1.0.0): Breaking changes to CONTRACT.yaml or adapter interface"
            echo ""
            echo "Current version: $BASE_VERSION"
            echo "Please update to a new version."
            exit 1
          fi

          echo "✅ Version updated: $BASE_VERSION -> $PR_VERSION"

      - name: Check CHANGELOG.md updated
        run: |
          # Check if CHANGELOG was modified in this PR
          if ! git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "CHANGELOG.md"; then
            echo "⚠️  Warning: CHANGELOG.md was not updated"
            echo "Please add an entry to CHANGELOG.md documenting your changes."
            exit 1
          fi

          echo "✅ CHANGELOG.md updated"

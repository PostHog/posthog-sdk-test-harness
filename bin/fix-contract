#!/usr/bin/env python3
"""Fix CONTRACT.yaml to ensure all action parameters are under 'params:' key."""

import sys

# Read the file
with open('CONTRACT.yaml') as f:
    lines = f.readlines()

# Process line by line
output_lines = []
i = 0
while i < len(lines):
    line = lines[i]
    output_lines.append(line)

    # Check if this is an action line
    if '- action:' in line and not line.strip().startswith('#'):
        indent = len(line) - len(line.lstrip())
        action_indent = ' ' * indent
        param_indent = ' ' * (indent + 2)

        # Look ahead to see if next line is 'params:'
        if i + 1 < len(lines):
            next_line = lines[i + 1]
            if 'params:' not in next_line and next_line.strip() and not next_line.strip().startswith('-'):
                # Next line is a parameter, not params:
                # Collect all parameter lines
                params = []
                j = i + 1
                while j < len(lines):
                    param_line = lines[j]
                    # Check if this line belongs to our action (same or greater indent)
                    param_line_indent = len(param_line) - len(param_line.lstrip())

                    # Stop if we hit another action or dedent
                    if param_line.strip().startswith('- action:') or param_line_indent < indent + 2:
                        break

                    if param_line.strip() and param_line_indent == indent + 2:
                        params.append(param_line)
                        j += 1
                    elif param_line.strip() and param_line_indent > indent + 2:
                        # Nested content, keep it
                        params.append(param_line)
                        j += 1
                    else:
                        j += 1
                        if not param_line.strip():
                            params.append(param_line)
                        else:
                            break

                # If we found params, wrap them
                if params:
                    output_lines.append(f"{param_indent}params:\n")
                    for param in params:
                        # Re-indent param lines
                        param_stripped = param.lstrip()
                        output_lines.append(f"{param_indent}  {param_stripped}")
                    i = j
                    continue

    i += 1

# Write output
with open('CONTRACT.yaml', 'w') as f:
    f.writelines(output_lines)

print("âœ“ Fixed CONTRACT.yaml")

#!/bin/bash
set -e

# Run SDK adapter tests using Docker Compose

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_ROOT"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

usage() {
    cat << EOF
Usage: bin/test [OPTIONS]

Run SDK adapter tests using Docker Compose.

OPTIONS:
    --adapter CONTEXT     Path to adapter directory (default: examples/curl_adapter)
    --build               Force rebuild of containers
    --down                Stop and remove containers after test
    --help                Show this help message

EXAMPLES:
    # Test the curl adapter example
    bin/test

    # Test with your own adapter
    bin/test --adapter /path/to/your/adapter

    # Rebuild and test
    bin/test --build

    # Test and cleanup
    bin/test --down

EOF
}

# Default values
ADAPTER_CONTEXT="examples/curl_adapter"
BUILD_FLAG=""
DOWN_FLAG=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --adapter)
            ADAPTER_CONTEXT="$2"
            shift 2
            ;;
        --build)
            BUILD_FLAG="--build"
            shift
            ;;
        --down)
            DOWN_FLAG="yes"
            shift
            ;;
        --help)
            usage
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            usage
            exit 1
            ;;
    esac
done

echo "=========================================="
echo "  PostHog SDK Test Harness (Docker)"
echo "=========================================="
echo ""
echo "Adapter: $ADAPTER_CONTEXT"
echo ""

# Update docker-compose.yml to use the specified adapter
# For now, we'll use the default one in docker-compose.yml
# In the future, we can make this dynamic

# Build and run
echo -e "${YELLOW}Building and starting containers...${NC}"
docker-compose up --abort-on-container-exit $BUILD_FLAG

# Capture exit code
EXIT_CODE=$?

# Cleanup if requested
if [ "$DOWN_FLAG" = "yes" ]; then
    echo ""
    echo -e "${YELLOW}Cleaning up containers...${NC}"
    docker-compose down
fi

# Report results
echo ""
if [ $EXIT_CODE -eq 0 ]; then
    echo -e "${GREEN}✓ Tests passed!${NC}"
else
    echo -e "${RED}✗ Tests failed${NC}"
fi

exit $EXIT_CODE

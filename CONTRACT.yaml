# PostHog SDK Adapter Contract
#
# This contract defines the interface that SDK adapters must implement
# and the compliance tests they must pass.

version: "1.0"

# SDK Adapter Interface
# All adapters must implement these endpoints
adapter_interface:
  # Health check - returns SDK information
  health:
    method: GET
    path: /health
    response:
      type: object
      required: [sdk_name, sdk_version, adapter_version]
      properties:
        sdk_name:
          type: string
          description: Name of the SDK (e.g., "posthog-python")
        sdk_version:
          type: string
          description: Version of the SDK being tested
        adapter_version:
          type: string
          description: Version of the adapter implementation

  # Initialize SDK with configuration
  init:
    method: POST
    path: /init
    request:
      type: object
      required: [api_key, host]
      properties:
        api_key:
          type: string
          description: PostHog API key
        host:
          type: string
          description: PostHog server URL
        flush_at:
          type: integer
          description: Number of events to batch before flushing
          default: 100
        flush_interval_ms:
          type: integer
          description: Time in milliseconds to wait before flushing
          default: 500
        max_retries:
          type: integer
          description: Maximum number of retries for failed requests
          default: 3
        enable_compression:
          type: boolean
          description: Enable gzip compression
          default: false
    response:
      type: object
      required: [success]
      properties:
        success:
          type: boolean

  # Capture a single event
  capture:
    method: POST
    path: /capture
    request:
      type: object
      required: [distinct_id, event]
      properties:
        distinct_id:
          type: string
          description: Unique identifier for the user
        event:
          type: string
          description: Event name
        properties:
          type: object
          description: Event properties
        timestamp:
          type: string
          format: iso8601
          description: Event timestamp
    response:
      type: object
      required: [success, uuid]
      properties:
        success:
          type: boolean
        uuid:
          type: string
          format: uuid
          description: Unique identifier for this event

  # Flush all pending events
  flush:
    method: POST
    path: /flush
    description: |
      Force the SDK to send all pending events immediately, bypassing any batching logic.
      This should block until all events have been sent (or failed permanently).

      Most SDKs batch events and send them when either:
      - The batch is full (e.g., 100 events)
      - A timer expires (e.g., 500ms)

      flush() overrides this behavior and sends everything immediately.

      Implementation: Call your SDK's flush() method (e.g., client.flush(), posthog.flush())
    response:
      type: object
      required: [success, events_flushed]
      properties:
        success:
          type: boolean
        events_flushed:
          type: integer
          description: Number of events that were successfully sent

  # Get internal SDK state for test assertions
  state:
    method: GET
    path: /state
    description: |
      Return the internal state of the SDK for test assertions.

      This endpoint allows the test harness to verify SDK behavior by inspecting:
      - How many events are queued vs sent
      - What HTTP requests were made (with status codes, retry attempts, UUIDs)
      - Whether retries are working correctly

      You'll need to instrument your SDK to track this information.
      See examples/minimal_adapter/adapter.py for implementation details.
    response:
      type: object
      required: [pending_events, total_events_captured, total_events_sent, total_retries, requests_made]
      properties:
        pending_events:
          type: integer
          description: Number of events in queue waiting to be sent
        total_events_captured:
          type: integer
          description: Total number of events captured
        total_events_sent:
          type: integer
          description: Total number of events successfully sent
        total_retries:
          type: integer
          description: Total number of retry attempts
        last_error:
          type: string
          nullable: true
          description: Last error message, if any
        requests_made:
          type: array
          description: List of HTTP requests made to the server
          items:
            type: object
            required: [timestamp_ms, status_code, retry_attempt, event_count, uuid_list]
            properties:
              timestamp_ms:
                type: integer
                description: Unix timestamp in milliseconds
              status_code:
                type: integer
                description: HTTP status code received
              retry_attempt:
                type: integer
                description: Retry attempt number (0 for first attempt)
              event_count:
                type: integer
                description: Number of events in this request
              uuid_list:
                type: array
                items:
                  type: string
                description: List of event UUIDs in this request

  # Reset SDK state
  reset:
    method: POST
    path: /reset
    response:
      type: object
      required: [success]
      properties:
        success:
          type: boolean

# Test Harness Actions
# These are actions that the test harness provides for writing tests

# Adapter Actions
# Actions that interact with the SDK adapter (init, capture, flush, etc.)
adapter_actions: !include contracts/adapter_actions.yaml

# Test Harness Actions
# Actions provided by the test harness (assertions, mock configuration, etc.)
test_actions: !include contracts/test_actions.yaml

# Test Suites
# Test suites are defined in separate files for maintainability
test_suites:
  # Event capture tests (capture, flush, batching, retries)
  capture: !include contracts/capture_tests.yaml

# SDK Adapter Implementation Guide

This guide explains how to create an SDK adapter for the PostHog test harness.

## What is an SDK Adapter?

An SDK adapter is a thin HTTP wrapper around your SDK that:
1. Exposes a standard REST API for the test harness to control
2. Tracks internal SDK state for test assertions
3. Allows the test harness to exercise your SDK programmatically

## Quick Start

See `examples/minimal_adapter/` for a complete, working example.

## Required Endpoints

Your adapter must implement these endpoints. See [CONTRACT.yaml](CONTRACT.yaml) for the complete specification.

### `GET /health`

Health check endpoint.

**Response:**
```json
{
  "sdk_name": "posthog-python",
  "sdk_version": "3.0.0",
  "adapter_version": "1.0.0"
}
```

### `POST /init`

Initialize the SDK with configuration.

**Request:**
```json
{
  "api_key": "phc_test_key",
  "host": "http://mock-server:8081",
  "flush_at": 100,
  "flush_interval_ms": 500,
  "max_retries": 3,
  "enable_compression": false
}
```

**Response:**
```json
{
  "success": true
}
```

**Notes:**
- All params except `api_key` and `host` are optional
- Use defaults from your SDK if params aren't provided
- Don't send events with `null` values - omit them instead

### `POST /capture`

Capture a single event.

**Request:**
```json
{
  "distinct_id": "user123",
  "event": "test_event",
  "properties": {"key": "value"},
  "timestamp": "2024-01-01T12:00:00Z"
}
```

**Response:**
```json
{
  "success": true,
  "uuid": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Notes:**
- `properties` and `timestamp` are optional
- Return the UUID generated by your SDK

### `POST /flush`

Flush all pending events and wait for completion.

**Response:**
```json
{
  "success": true,
  "events_flushed": 5
}
```

**Notes:**
- This should block until all events are sent
- Return the number of events that were flushed

### `GET /state`

Get internal SDK state for test assertions.

**Response:**
```json
{
  "pending_events": 0,
  "total_events_captured": 10,
  "total_events_sent": 10,
  "total_retries": 2,
  "last_error": null,
  "requests_made": [
    {
      "timestamp_ms": 1704110400000,
      "status_code": 200,
      "retry_attempt": 0,
      "event_count": 5,
      "uuid_list": ["uuid1", "uuid2", ...]
    }
  ]
}
```

**Notes:**
- You'll need to intercept HTTP requests to track `requests_made`
- Each retry of the same batch should increment `retry_attempt`
- See `examples/minimal_adapter/adapter.py` for implementation details

### `POST /reset`

Reset SDK state and clear all pending events.

**Response:**
```json
{
  "success": true
}
```

## Implementation Tips

### 1. State Tracking

You need to track:
- Events captured vs sent
- HTTP requests made (with status codes and UUIDs)
- Retry attempts
- Errors

Example (Python):
```python
class AdapterState:
    def __init__(self):
        self.lock = threading.Lock()
        self.total_events_captured = 0
        self.total_events_sent = 0
        self.requests_made = []
```

### 2. Request Interception

To track HTTP requests, intercept your SDK's HTTP client:

Example (Python, monkey-patching):
```python
original_post = sdk.http_client.post

def tracked_post(*args, **kwargs):
    response = original_post(*args, **kwargs)
    state.record_request(response.status_code, ...)
    return response

sdk.http_client.post = tracked_post
```

### 3. Handling Optional Parameters

Don't send `null` values in requests:

```python
# Bad
payload = {"flush_at": None}  # Prevents adapter defaults from working

# Good
payload = {}
if flush_at is not None:
    payload["flush_at"] = flush_at
```

### 4. Thread Safety

Use locks when tracking state from background threads:

```python
with state.lock:
    state.total_events_sent += 1
```

## Testing Your Adapter

### Locally with Docker

```bash
# 1. Create a Dockerfile for your adapter
cat > Dockerfile << 'EOF'
FROM python:3.12
WORKDIR /app
COPY . .
RUN pip install -r requirements.txt
CMD ["python", "adapter.py"]
EOF

# 2. Test it
git clone https://github.com/PostHog/posthog-sdk-test-harness.git
cd posthog-sdk-test-harness

# 3. Create docker-compose.override.yml
cp docker-compose.override.yml.example docker-compose.override.yml
# Edit to point to your adapter

# 4. Run tests
bin/test --build
```

### In CI/CD

Add to your `.github/workflows/test.yml`:

```yaml
- name: Run SDK Compliance Tests
  uses: PostHog/posthog-sdk-test-harness/.github/workflows/test-sdk-action.yml@v1
  with:
    adapter-dockerfile: "sdk_adapter/Dockerfile"
    adapter-context: "."
```

## Common Issues

### "Expected N requests, got 0"

Your adapter is sending events to the wrong host. Make sure you're using the `host` parameter from `/init`.

### "UUID not preserved on retry"

Make sure UUIDs are generated once and reused on retry attempts, not regenerated.

### "Retry delay too short"

Implement exponential backoff and respect `Retry-After` headers.

## Full Example

See [examples/minimal_adapter/adapter.py](examples/minimal_adapter/adapter.py) for a complete, working adapter implementation with:
- Event queueing
- Retry logic with exponential backoff
- Retry-After header support
- Full state tracking
- Thread safety
